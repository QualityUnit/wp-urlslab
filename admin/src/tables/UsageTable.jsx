import { useEffect, useMemo, useState } from 'react';
import { __ } from '@wordpress/i18n/';
import {
	useInfiniteFetch,
	Loader,
	Table,
	ModuleViewHeaderBottom,
	TooltipSortingFiltering,
	DateTimeFormat,
} from '../lib/tableImports';

import useTableStore from '../hooks/useTableStore';
import useTablePanels from '../hooks/useTablePanels';
import DescriptionBox from '../elements/DescriptionBox';

import '../assets/styles/components/_ModuleViewHeader.scss';

const paginationId = 'id';
const header = {
	groupBucketTitle: __( 'Date' ),
	installationId: __( 'Installation ID' ),
	creditType: __( 'Type' ),
	events: __( 'Count' ),
	credits: __( 'Usage' ),
};
const initialState = { columnVisibility: { events: false } };

// init table state with fixed states which we do not need to update anymore during table lifecycle
export default function TableInit( { slug } ) {
	const setTable = useTableStore( ( state ) => state.setTable );
	const [ init, setInit ] = useState( false );
	useEffect( () => {
		setInit( true );
		setTable( slug, {
			paginationId,
			slug,
			header,
		} );
		useTablePanels.setState( () => (
			{
				deleteCSVCols: [ paginationId ],
			}
		) );
	}, [ setTable, slug ] );

	return init && <UsageTable slug={ slug } />;
}

function UsageTable( { slug } ) {
	const {
		columnHelper,
		data,
		isLoading,
		isSuccess,
	} = useInfiniteFetch( { slug }, 500 );

	const tableData = useMemo( () => data?.pages?.flatMap( ( page ) => page ?? [] ), [ data?.pages ] );
	const setTable = useTableStore( ( state ) => state.setTable );

	const columns = useMemo( () => [
		columnHelper.accessor( 'groupBucketTitle', {
			cell: ( cell ) => <DateTimeFormat noTime datetime={ cell.getValue() } />,
			header: header.groupBucketTitle,
			size: 200,
		} ),
		columnHelper.accessor( 'installationId', {
			header: header.installationId,
			size: 60,
		} ),
		columnHelper.accessor( 'creditType', {
			header: header.creditType,
			size: 100,
		} ),
		columnHelper.accessor( 'events', {
			header: header.events,
			size: 100,
		} ),
		columnHelper.accessor( 'credits', {
			header: header.credits,
			size: 100,
		} ),
	], [ columnHelper ] );

	useEffect( () => {
		setTable( slug, { data } );
	}, [ data, setTable, slug ] );

	if ( isLoading ) {
		return <Loader isFullscreen />;
	}

	return (
		<>
			<DescriptionBox	title={ __( 'About this table' ) } tableSlug={ slug } isMainTableDescription>
				{ __( 'The table displays the charges deducted from your credit balance, categorized by transaction type and date. These charges are associated with tasks run by your API key. If multiple WordPress installations use the same API key, the table will also show the costs generated by all installations.' ) }
			</DescriptionBox>

			<ModuleViewHeaderBottom noFiltering noCount hideActions />

			<Table
				className="fadeInto"
				columns={ columns }
				data={ isSuccess && tableData }
				initialState={ initialState }
			>
				<TooltipSortingFiltering />
			</Table>
		</>
	);
}
